from ShrutiMusic import app
from pyrogram import filters
from pyrogram.types import Message
from ShrutiMusic.core.mongo import mongodb
from ShrutiMusic.utils.permissions import adminsOnly, member_permissions, SUDOERS
import re
import asyncio

async def get_group_settings(chat_id):
    data = await mongodb.bio_guardians.find_one({"chat_id": chat_id})
    if not data:
        data = {
            "chat_id": chat_id,
            "biolink_status": False,
            "admin_biolink_status": False,
            "biousername_status": False,
            "admin_biousername_status": False,
            "free_bio_users": []
        }
        await mongodb.bio_guardians.insert_one(data)
    return data

async def set_group_settings(chat_id, key, value):
    await mongodb.bio_guardians.update_one(
        {"chat_id": chat_id}, {"$set": {key: value}}, upsert=True
    )

async def add_free_bio_user(chat_id, user_id):
    await mongodb.bio_guardians.update_one(
        {"chat_id": chat_id}, {"$addToSet": {"free_bio_users": user_id}}, upsert=True
    )

async def remove_free_bio_user(chat_id, user_id):
    await mongodb.bio_guardians.update_one(
        {"chat_id": chat_id}, {"$pull": {"free_bio_users": user_id}}
    )

async def get_user_bio(user_id):
    """Get user bio using different methods"""
    bio = ""
    try:
        # Method 1: Try get_chat
        chat_info = await app.get_chat(user_id)
        bio = getattr(chat_info, 'bio', None) or getattr(chat_info, 'description', None) or ""
    except Exception as e:
        try:
            # Method 2: Try get_users
            user = await app.get_users(user_id)
            bio = getattr(user, 'bio', None) or ""
        except Exception as e2:
            pass

    return bio.strip()

async def has_bio_link(bio_text):
    if not bio_text:
        return False

    patterns = [
        r'http[s]?://[^\s]+',
        r'www\.[^\s]+',
        r't\.me/[^\s]+',
        r'telegram\.me/[^\s]+',
        r'[a-zA-Z0-9-]+\.(com|org|net|in|co|io|me|cc|tv|info|biz|edu|gov)[^\s]*',
        r'[a-zA-Z0-9-]+\.[a-zA-Z]{2,}[^\s]*',
    ]
    
    for pattern in patterns:
        if re.search(pattern, bio_text, re.IGNORECASE):
            return True
    return False

async def has_bio_username(bio_text):
    if not bio_text:
        return False

    patterns = [
        r'@[a-zA-Z0-9_]{1,}',
        r'telegram\.me/[^\s]+',
        r't\.me/[^\s]+',
        r'(?:contact|dm|msg|message)[\s:@]*[a-zA-Z0-9_]+',
    ]
    
    for pattern in patterns:
        if re.search(pattern, bio_text, re.IGNORECASE):
            return True
    return False

# All your command handlers (YEH PEHLE SE HI WORK KAR RAHE HAIN)
@app.on_message(filters.command("biolink") & filters.group)
@adminsOnly("can_change_info")
async def biolink_toggle(client, message: Message):
    if len(message.command) < 2 or message.command[1].lower() not in ["on", "off"]:
        return await message.reply_text("Usage: /biolink on or /biolink off")

    status = message.command[1].lower() == "on"
    await set_group_settings(message.chat.id, "biolink_status", status)
    await message.reply_text(
        f"âœ… <b>Bio link protection for users</b> is now <b>{'enabled' if status else 'disabled'}</b>."
    )

@app.on_message(filters.command("adminbiolink") & filters.group)
@adminsOnly("can_change_info")
async def admin_biolink_toggle(client, message: Message):
    if len(message.command) < 2 or message.command[1].lower() not in ["on", "off"]:
        return await message.reply_text("Usage: /adminbiolink on or /adminbiolink off")

    status = message.command[1].lower() == "on"
    await set_group_settings(message.chat.id, "admin_biolink_status", status)
    await message.reply_text(
        f"âœ… <b>Bio link protection for admins</b> is now <b>{'enabled' if status else 'disabled'}</b>."
    )

@app.on_message(filters.command("biousername") & filters.group)
@adminsOnly("can_change_info")
async def biousername_toggle(client, message: Message):
    if len(message.command) < 2 or message.command[1].lower() not in ["on", "off"]:
        return await message.reply_text("Usage: /biousername on or /biousername off")

    status = message.command[1].lower() == "on"
    await set_group_settings(message.chat.id, "biousername_status", status)
    await message.reply_text(
        f"âœ… <b>Bio username protection for users</b> is now <b>{'enabled' if status else 'disabled'}</b>."
    )

@app.on_message(filters.command("adminbiousername") & filters.group)
@adminsOnly("can_change_info")
async def admin_biousername_toggle(client, message: Message):
    if len(message.command) < 2 or message.command[1].lower() not in ["on", "off"]:
        return await message.reply_text("Usage: /adminbiousername on or /adminbiousername off")

    status = message.command[1].lower() == "on"
    await set_group_settings(message.chat.id, "admin_biousername_status", status)
    await message.reply_text(
        f"âœ… <b>Bio username protection for admins</b> is now <b>{'enabled' if status else 'disabled'}</b>."
    )

@app.on_message(filters.command("freebio") & filters.group)
@adminsOnly("can_change_info")
async def free_bio_user(client, message: Message):
    if len(message.command) < 2 and not message.reply_to_message:
        return await message.reply_text(
            "Usage: /freebio <username|user_id> or reply to a user"
        )

    chat_id = message.chat.id
    target_user = None
    target_name = ""
    
    try:
        if message.reply_to_message:
            target_user = message.reply_to_message.from_user.id
            target_name = message.reply_to_message.from_user.first_name
        else:
            try:
                target_user = int(message.command[1])
                user = await app.get_users(target_user)
                target_name = user.first_name
            except ValueError:
                user = await app.get_users(message.command[1])
                target_user = user.id
                target_name = user.first_name
        
        await add_free_bio_user(chat_id, target_user)
        await message.reply_text(
            f"âœ… <b>{target_name}</b> <code>({target_user})</code> is now <b>free from bio checks</b>."
        )
    except Exception as e:
        await message.reply_text(f"âŒ <b>Error:</b> User not found or invalid input.")

@app.on_message(filters.command("removefreebio") & filters.group)
@adminsOnly("can_change_info")
async def remove_free_bio(client, message: Message):
    if len(message.command) < 2 and not message.reply_to_message:
        return await message.reply_text(
            "Usage: /removefreebio <username|user_id> or reply to a user"
        )

    chat_id = message.chat.id
    target_user = None
    target_name = ""
    
    try:
        if message.reply_to_message:
            target_user = message.reply_to_message.from_user.id
            target_name = message.reply_to_message.from_user.first_name
        else:
            try:
                target_user = int(message.command[1])
                user = await app.get_users(target_user)
                target_name = user.first_name
            except ValueError:
                user = await app.get_users(message.command[1])
                target_user = user.id
                target_name = user.first_name
        
        await remove_free_bio_user(chat_id, target_user)
        await message.reply_text(
            f"âŒ <b>{target_name}</b> <code>({target_user})</code> is no longer <b>free from bio checks</b>."
        )
    except Exception as e:
        await message.reply_text(f"âŒ <b>Error:</b> User not found or invalid input.")

@app.on_message(filters.command("biostatus") & filters.group)
@adminsOnly("can_change_info")
async def bio_status(client, message: Message):
    settings = await get_group_settings(message.chat.id)

    status_text = f"""
ğŸ›¡ï¸ Bio Guardian Settings

ğŸ“ Bio Link Protection:
â”œ Users: {'âœ… Enabled' if settings['biolink_status'] else 'âŒ Disabled'}
â”” Admins: {'âœ… Enabled' if settings['admin_biolink_status'] else 'âŒ Disabled'}

ğŸ‘¤ Bio Username Protection:
â”œ Users: {'âœ… Enabled' if settings['biousername_status'] else 'âŒ Disabled'}
â”” Admins: {'âœ… Enabled' if settings['admin_biousername_status'] else 'âŒ Disabled'}

ğŸ†“ Free Users: {len(settings.get('free_bio_users', []))} users
"""
    await message.reply_text(status_text)

@app.on_message(filters.command("checkbio") & filters.group)
@adminsOnly("can_change_info")
async def check_bio_manual(client, message: Message):
    if not message.reply_to_message:
        return await message.reply_text("Reply to a user to check their bio!")

    user_id = message.reply_to_message.from_user.id
    try:
        user = await app.get_users(user_id)
        bio = await get_user_bio(user_id)
        if not bio:
            bio = "No bio found"
        
        has_link = await has_bio_link(bio)
        has_username = await has_bio_username(bio)
        
        await message.reply_text(
            f"<b>User:</b> {user.first_name}\n"
            f"<b>User ID:</b> <code>{user_id}</code>\n"
            f"<b>Bio:</b> <code>{bio}</code>\n"
            f"<b>Has Link:</b> {'âœ…' if has_link else 'âŒ'}\n"
            f"<b>Has Username:</b> {'âœ…' if has_username else 'âŒ'}"
        )
    except Exception as e:
        await message.reply_text(f"Error: {e}")

# NEW APPROACH: LOW PRIORITY HANDLER THAT ONLY PROCESSES NON-COMMAND MESSAGES
@app.on_message(
    filters.group & 
    filters.incoming & 
    ~filters.bot & 
    ~filters.service &
    ~filters.me  # Skip own messages
)
async def bio_guardian_low_priority(client, message: Message):
    """
    This handler has lowest priority and only processes messages that 
    are NOT commands and NOT from bots
    """
    try:
        # Quick check if we should process this message
        if not message or not message.from_user:
            return
            
        chat_id = message.chat.id
        user_id = message.from_user.id

        # Skip if user is SUDOER
        if user_id in SUDOERS:
            return

        settings = await get_group_settings(chat_id)
        
        # Skip if all protections are disabled
        if (not settings.get("biolink_status", False) and 
            not settings.get("admin_biolink_status", False) and 
            not settings.get("biousername_status", False) and 
            not settings.get("admin_biousername_status", False)):
            return
        
        # Skip if user is in free bio users list
        if user_id in settings.get("free_bio_users", []):
            return

        # Get user info
        try:
            user = await app.get_users(user_id)
        except:
            return

        # Get bio
        bio = await get_user_bio(user_id)
        if not bio:
            return

        # Check if user is admin
        try:
            permissions = await member_permissions(chat_id, user_id)
            is_admin = "can_change_info" in permissions or any(
                perm in permissions for perm in 
                ["can_delete_messages", "can_restrict_members", "can_promote_members"]
            )
        except:
            is_admin = False

        violation_found = False
        violation_reason = ""

        # Check Bio Link Protection
        if is_admin and settings.get("admin_biolink_status", False):
            if await has_bio_link(bio):
                violation_found = True
                violation_reason = "bio contains a <b>link</b>"
        elif not is_admin and settings.get("biolink_status", False):
            if await has_bio_link(bio):
                violation_found = True
                violation_reason = "bio contains a <b>link</b>"

        # Check Bio Username Protection
        if not violation_found:
            if is_admin and settings.get("admin_biousername_status", False):
                if await has_bio_username(bio):
                    violation_found = True
                    violation_reason = "bio contains a <b>username</b>"
            elif not is_admin and settings.get("biousername_status", False):
                if await has_bio_username(bio):
                    violation_found = True
                    violation_reason = "bio contains a <b>username</b>"

        if violation_found:
            try:
                await message.delete()
                
                warning_msg = await client.send_message(
                    chat_id,
                    f"âš ï¸ {user.mention}, your message was deleted because your {violation_reason}.",
                    reply_to_message_id=None
                )
                
                await asyncio.sleep(10)
                try:
                    await warning_msg.delete()
                except:
                    pass
                    
            except Exception as e:
                pass

    except Exception as e:
        pass

print("âœ… Bio Guardian Plugin Loaded Successfully!")
